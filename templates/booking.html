{% extends "base.html" %}
{% block title %}Complete Your Booking - Skyela{% endblock %}

{% block head %}
<style>
body {
  background: linear-gradient(135deg, #caf0f8 0%, #ade8f4 100%);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.booking-hero {
  background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
  padding: 4rem 2rem;
  text-align: center;
  color: white;
  margin-bottom: 3rem;
  border-radius: 24px;
  box-shadow: 0 20px 60px rgba(0, 119, 182, 0.25);
}

.booking-hero h2 {
  font-size: 3rem;
  margin-bottom: 0.8rem;
  font-weight: 700;
  letter-spacing: -1px;
}

.booking-subtitle {
  font-size: 1.25rem;
  opacity: 0.95;
  font-weight: 300;
}

.booking-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 2rem 4rem 2rem;
}

.booking-layout {
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 2.5rem;
  align-items: start;
}

.booking-main {
  background: white;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 119, 182, 0.1);
  overflow: hidden;
  border: 1px solid rgba(0, 119, 182, 0.1);
}

.booking-section {
  padding: 2.5rem;
  border-bottom: 2px solid #f3f4f6;
}

.booking-section:last-child {
  border-bottom: none;
}

.section-header {
  margin-bottom: 2rem;
}

.section-header h3 {
  font-size: 1.75rem;
  color: #0077b6;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  letter-spacing: -0.5px;
}

.section-header h3::before {
  content: '';
  width: 5px;
  height: 28px;
  background: linear-gradient(180deg, #0077b6, #00b4d8);
  border-radius: 4px;
}

.passenger-card {
  background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 1.5rem;
  border: 2px solid #e5e7eb;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.passenger-card:hover {
  border-color: #0077b6;
  box-shadow: 0 8px 24px rgba(0, 119, 182, 0.15);
  transform: translateY(-2px);
}

.passenger-card h4 {
  color: #0077b6;
  font-size: 1.3rem;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.passenger-tag {
  font-size: 0.8rem;
  background: linear-gradient(135deg, #0077b6, #00b4d8);
  color: white;
  padding: 0.35rem 0.9rem;
  border-radius: 20px;
  font-weight: 600;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 8px rgba(0, 119, 182, 0.3);
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.6rem;
  font-size: 0.95rem;
}

.required {
  color: #ef4444;
}

.form-group input,
.form-group select {
  padding: 1rem 1.25rem;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 1rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  background: white;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #0077b6;
  box-shadow: 0 0 0 4px rgba(0, 119, 182, 0.1);
  background: #f0f9ff;
}

.contact-info {
  background: linear-gradient(135deg, rgba(0, 119, 182, 0.03), rgba(0, 180, 216, 0.03));
  border: 2px solid rgba(0, 119, 182, 0.15);
}

.terms-box {
  background: linear-gradient(135deg, #fff9e6 0%, #fffaf0 100%);
  border: 2px solid #fbbf24;
  border-radius: 16px;
  padding: 1.75rem;
  box-shadow: 0 4px 12px rgba(251, 191, 36, 0.1);
}

.checkbox-label {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  cursor: pointer;
  font-size: 0.98rem;
  color: #374151;
}

.checkbox-label input[type="checkbox"] {
  margin-top: 0.25rem;
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #0077b6;
}

.terms-link {
  color: #0077b6;
  text-decoration: none;
  font-weight: 600;
  border-bottom: 2px solid transparent;
  transition: border-color 0.2s;
}

.terms-link:hover {
  border-bottom-color: #0077b6;
}

.booking-actions {
  padding: 2.5rem;
  display: flex;
  gap: 1.25rem;
  justify-content: flex-end;
  background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
  border-radius: 0 0 20px 20px;
}

.btn-primary,
.btn-secondary {
  padding: 1.15rem 3rem;
  font-size: 1.1rem;
  font-weight: 700;
  border-radius: 14px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: none;
  display: inline-flex;
  align-items: center;
  gap: 0.65rem;
  letter-spacing: 0.3px;
}

.btn-primary {
  background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
  color: white;
  box-shadow: 0 8px 20px rgba(0, 119, 182, 0.35);
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 28px rgba(0, 119, 182, 0.45);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  background: white;
  color: #0077b6;
  border: 2px solid #0077b6;
  text-decoration: none;
}

.btn-secondary:hover {
  background: #f0f9ff;
  border-color: #00b4d8;
  color: #00b4d8;
}

.booking-sidebar {
  position: sticky;
  top: 2rem;
  height: fit-content;
}

.booking-card {
  background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 12px 40px rgba(0, 119, 182, 0.3);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.summary-header {
  padding: 2.5rem;
  background: rgba(255, 255, 255, 0.1);
  border-bottom: 1px solid rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
}

.summary-header h3 {
  font-size: 1.65rem;
  margin: 0;
  color: white;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.trip-route {
  padding: 2.5rem;
}

.route-item {
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.12);
  border-radius: 14px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.15);
}

.route-label {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: #90e0ef;
  font-weight: 700;
}

.route-cities {
  font-size: 1.4rem;
  font-weight: 800;
  margin: 0.6rem 0;
  color: white;
  letter-spacing: -0.5px;
}

.route-date,
.route-cabin {
  font-size: 0.95rem;
  color: rgba(255,255,255,0.9);
  font-weight: 500;
}

.route-divider {
  height: 1.25rem;
}

.price-breakdown {
  padding: 2.5rem;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
}

.passengers-summary,
.seats-summary {
  margin-bottom: 1.75rem;
  padding-bottom: 1.75rem;
  border-bottom: 1px solid rgba(255,255,255,0.15);
}

.passengers-header,
.seats-header {
  font-weight: 700;
  font-size: 0.95rem;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: #90e0ef;
  margin-bottom: 1rem;
}

.price-row {
  display: flex;
  justify-content: space-between;
  padding: 0.65rem 0;
  color: rgba(255,255,255,0.95);
  font-size: 1rem;
  font-weight: 500;
}

.price-total {
  display: flex;
  justify-content: space-between;
  padding: 1.75rem 0 0 0;
  margin-top: 1.25rem;
  border-top: 2px solid rgba(255,255,255,0.25);
  font-size: 1.75rem;
  font-weight: 800;
  color: #48cae4;
  letter-spacing: -0.5px;
}

.security-badge {
  padding: 2rem 2.5rem;
  background: rgba(255, 255, 255, 0.1);
  display: flex;
  align-items: center;
  gap: 1.25rem;
  backdrop-filter: blur(10px);
  border-top: 1px solid rgba(255, 255, 255, 0.15);
}

.security-badge::before {
  content: 'üîí';
  font-size: 2.25rem;
}

.badge-text {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}

.badge-text strong {
  color: #90e0ef;
  font-size: 1rem;
  font-weight: 700;
}

.badge-text span {
  font-size: 0.85rem;
  color: rgba(255,255,255,0.8);
  font-weight: 400;
}

.stripe-card-element {
  padding: 1rem 1.25rem;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.stripe-card-element:focus-within {
  border-color: #0077b6;
  box-shadow: 0 0 0 4px rgba(0, 119, 182, 0.1);
  background: #f0f9ff;
}

.card-errors {
  color: #ef4444;
  font-size: 0.95rem;
  margin-top: 0.65rem;
  min-height: 22px;
  font-weight: 500;
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spinner 0.6s linear infinite;
}

@keyframes spinner {
  to { transform: rotate(360deg); }
}

.hidden {
  display: none !important;
}

@media (max-width: 1024px) {
  .booking-layout {
    grid-template-columns: 1fr;
  }
  
  .booking-sidebar {
    position: relative;
    top: 0;
    order: -1;
  }
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .booking-hero h2 {
    font-size: 2rem;
  }
  
  .booking-container {
    padding: 0 1rem 2rem 1rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="booking-hero">
  <h2>‚úàÔ∏è Complete Your Booking</h2>
  <p class="booking-subtitle">Just a few more details and you're ready to fly!</p>
</div>

<div class="booking-container">
  <div class="booking-layout">
    <!-- Left: Passenger Details Form -->
    <div class="booking-main">
      <form id="bookingForm">
        <!-- Hidden fields for flight data -->
        <input type="hidden" name="outbound_json" id="outbound_json" value='{{ outbound | tojson | safe }}'>
        {% if return_flight %}
          <input type="hidden" name="return_json" id="return_json" value='{{ return_flight | tojson | safe }}'>
          <input type="hidden" name="cabin_ret" id="cabin_ret" value="{{ cabin_ret }}">
        {% endif %}
        <input type="hidden" name="cabin_out" id="cabin_out" value="{{ cabin_out }}">
        <input type="hidden" name="total_price" id="total_price" value="{{ total_price }}">

        <!-- Passenger Information Section -->
        <div class="booking-section">
          <div class="section-header">
            <h3>Passenger Information ({{ total_passengers }} Passenger{{ 's' if total_passengers > 1 else '' }})</h3>
          </div>
          
          <!-- Adult Passengers -->
          {% for i in range(adults) %}
          <div class="passenger-card">
            <h4>Adult {{ i + 1 }}</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="adult_{{ i }}_first_name">First Name <span class="required">*</span></label>
                <input type="text" id="adult_{{ i }}_first_name" name="adult_{{ i }}_first_name" required 
                       placeholder="First name">
              </div>
              <div class="form-group">
                <label for="adult_{{ i }}_last_name">Last Name <span class="required">*</span></label>
                <input type="text" id="adult_{{ i }}_last_name" name="adult_{{ i }}_last_name" required 
                       placeholder="Last name">
              </div>
              <div class="form-group">
                <label for="adult_{{ i }}_nationality">Nationality <span class="required">*</span></label>
                <select id="adult_{{ i }}_nationality" name="adult_{{ i }}_nationality" required>
                  <option value="" disabled selected>Select nationality</option>
                  {% for code, name in COUNTRY_NAMES|dictsort(by='value') %}
                    <option value="{{ code }}">{{ name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label for="adult_{{ i }}_dob">Date of Birth <span class="required">*</span></label>
                <input type="date" id="adult_{{ i }}_dob" name="adult_{{ i }}_dob" required>
              </div>
              <div class="form-group">
                <label for="adult_{{ i }}_passport">Passport Number</label>
                <input type="text" id="adult_{{ i }}_passport" name="adult_{{ i }}_passport" 
                       placeholder="Optional">
              </div>
            </div>
          </div>
          {% endfor %}
          
          <!-- Child Passengers -->
          {% for i in range(children) %}
          <div class="passenger-card child-passenger">
            <h4>Child {{ i + 1 }} <span class="passenger-tag">2-11 years</span></h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="child_{{ i }}_first_name">First Name <span class="required">*</span></label>
                <input type="text" id="child_{{ i }}_first_name" name="child_{{ i }}_first_name" required 
                       placeholder="First name">
              </div>
              <div class="form-group">
                <label for="child_{{ i }}_last_name">Last Name <span class="required">*</span></label>
                <input type="text" id="child_{{ i }}_last_name" name="child_{{ i }}_last_name" required 
                       placeholder="Last name">
              </div>
              <div class="form-group">
                <label for="child_{{ i }}_nationality">Nationality <span class="required">*</span></label>
                <select id="child_{{ i }}_nationality" name="child_{{ i }}_nationality" required>
                  <option value="" disabled selected>Select nationality</option>
                  {% for code, name in COUNTRY_NAMES|dictsort(by='value') %}
                    <option value="{{ code }}">{{ name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label for="child_{{ i }}_dob">Date of Birth <span class="required">*</span></label>
                <input type="date" id="child_{{ i }}_dob" name="child_{{ i }}_dob" required>
              </div>
              <div class="form-group">
                <label for="child_{{ i }}_passport">Passport Number</label>
                <input type="text" id="child_{{ i }}_passport" name="child_{{ i }}_passport" 
                       placeholder="Optional">
              </div>
            </div>
          </div>
          {% endfor %}
          
          <!-- Infant Passengers -->
          {% for i in range(infants) %}
          <div class="passenger-card infant-passenger">
            <h4>Infant {{ i + 1 }} <span class="passenger-tag">Under 2 years</span></h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="infant_{{ i }}_first_name">First Name <span class="required">*</span></label>
                <input type="text" id="infant_{{ i }}_first_name" name="infant_{{ i }}_first_name" required 
                       placeholder="First name">
              </div>
              <div class="form-group">
                <label for="infant_{{ i }}_last_name">Last Name <span class="required">*</span></label>
                <input type="text" id="infant_{{ i }}_last_name" name="infant_{{ i }}_last_name" required 
                       placeholder="Last name">
              </div>
              <div class="form-group">
                <label for="infant_{{ i }}_nationality">Nationality <span class="required">*</span></label>
                <select id="infant_{{ i }}_nationality" name="infant_{{ i }}_nationality" required>
                  <option value="" disabled selected>Select nationality</option>
                  {% for code, name in COUNTRY_NAMES|dictsort(by='value') %}
                    <option value="{{ code }}">{{ name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label for="infant_{{ i }}_dob">Date of Birth <span class="required">*</span></label>
                <input type="date" id="infant_{{ i }}_dob" name="infant_{{ i }}_dob" required>
              </div>
              <div class="form-group">
                <label for="infant_{{ i }}_passport">Passport Number</label>
                <input type="text" id="infant_{{ i }}_passport" name="infant_{{ i }}_passport" 
                       placeholder="Optional">
              </div>
            </div>
          </div>
          {% endfor %}
          
          <!-- Contact Information -->
          <div class="passenger-card contact-info">
            <h4>Contact Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="email">Email Address <span class="required">*</span></label>
                <input type="email" id="email" name="email" required 
                       placeholder="your.email@example.com">
              </div>
              <div class="form-group">
                <label for="phone">Phone Number <span class="required">*</span></label>
                <input type="tel" id="phone" name="phone" required 
                       placeholder="+1 (555) 000-0000">
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Information Section -->
        <div class="booking-section">
          <div class="section-header">
            <h3>Payment Information</h3>
          </div>
          
          <!-- Stripe Card Element -->
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="card-element">Card Details <span class="required">*</span></label>
              <div id="card-element" class="stripe-card-element">
                <!-- Stripe.js injects the Card Element here -->
              </div>
              <div id="card-errors" role="alert" class="card-errors"></div>
            </div>
            <div class="form-group full-width">
              <label for="billing_address">Billing Address <span class="required">*</span></label>
              <input type="text" id="billing_address" name="billing_address" required 
                     placeholder="Street address, City, State, ZIP">
            </div>
          </div>
        </div>

        <!-- Terms and Conditions -->
        <div class="booking-section">
          <div class="terms-box">
            <label class="checkbox-label">
              <input type="checkbox" id="terms" name="terms" required>
              <span>I agree to the <a href="#" class="terms-link">Terms & Conditions</a> and <a href="#" class="terms-link">Privacy Policy</a></span>
            </label>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="booking-actions">
          <a href="{{ url_for('search') }}" class="btn-secondary">Cancel</a>
          <button type="submit" class="btn-primary" id="submit-button">
            <span id="button-text">Complete Booking</span>
            <div id="spinner" class="spinner hidden"></div>
          </button>
        </div>
      </form>
    </div>

    <!-- Right: Booking Summary -->
    <aside class="booking-sidebar">
      <div class="summary-sticky">
        <div class="booking-card">
          <div class="summary-header">
            <h3>Booking Summary</h3>
          </div>

          <!-- Trip Route -->
          <div class="trip-route">
            <div class="route-item">
              <div class="route-details">
                <div class="route-label">Outbound</div>
                <div class="route-cities">{{ origin_city }} ‚Üí {{ destination_city }}</div>
                <div class="route-date">{{ outbound.departure | date_compact }}</div>
                <div class="route-cabin">{{ cabin_out }}</div>
              </div>
            </div>
            {% if return_flight %}
            <div class="route-divider"></div>
            <div class="route-item">
              <div class="route-details">
                <div class="route-label">Return</div>
                <div class="route-cities">{{ destination_city }} ‚Üí {{ origin_city }}</div>
                <div class="route-date">{{ return_flight.departure | date_compact }}</div>
                <div class="route-cabin">{{ cabin_ret }}</div>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Price Breakdown -->
          <div class="price-breakdown">
            <!-- Passenger Breakdown -->
            <div class="passengers-summary">
              <div class="passengers-header">Passengers</div>
              {% if adults > 0 %}
              <div class="price-row passenger-row">
                <span>{{ adults }} Adult{{ 's' if adults > 1 else '' }}</span>
                <span>${{ "%.2f" | format(adult_price|float * adults) }}</span>
              </div>
              {% endif %}
              {% if children > 0 %}
              <div class="price-row passenger-row">
                <span>{{ children }} Child{{ 'ren' if children > 1 else '' }} (75%)</span>
                <span>${{ "%.2f" | format(child_price|float * children) }}</span>
              </div>
              {% endif %}
              {% if infants > 0 %}
              <div class="price-row passenger-row">
                <span>{{ infants }} Infant{{ 's' if infants > 1 else '' }} (10%)</span>
                <span>${{ "%.2f" | format(infant_price|float * infants) }}</span>
              </div>
              {% endif %}
            </div>
            
            <!-- Seat Selection Breakdown -->
            {% if selected_seats and selected_seats != '' %}
            <div class="seats-summary">
              <div class="seats-header">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
                  <rect x="4" y="4" width="16" height="16" rx="2"></rect>
                  <rect x="9" y="9" width="6" height="6"></rect>
                  <path d="M9 1v3"></path>
                  <path d="M15 1v3"></path>
                  <path d="M9 20v3"></path>
                  <path d="M15 20v3"></path>
                </svg>
                Selected Seats
              </div>
              {% set seat_total = 0 %}
              {% for seat_info in selected_seats.split(',') if seat_info %}
                {% set seat_parts = seat_info.split(':') %}
                {% if seat_parts|length == 2 %}
                  {% set seat_number = seat_parts[0] %}
                  {% set seat_price = seat_parts[1]|float %}
                  {% set seat_total = seat_total + seat_price %}
                  <div class="price-row seat-row">
                    <span>Seat {{ seat_number }}</span>
                    <span>${{ "%.2f" | format(seat_price) }}</span>
                  </div>
                {% endif %}
              {% endfor %}
              <div class="price-row seat-total">
                <span><strong>Seats Subtotal</strong></span>
                <span><strong>${{ "%.2f" | format(seat_total) }}</strong></span>
              </div>
            </div>
            {% endif %}
            
            {% if base_total %}
            <div class="price-row">
              <span>Fare subtotal</span>
              <span>${{ base_total }}</span>
            </div>
            {% endif %}
            {% if taxes_total %}
            <div class="price-row">
              <span>Taxes & fees</span>
              <span>${{ taxes_total }}</span>
            </div>
            {% else %}
            <div class="price-row">
              <span>Taxes & fees</span>
              <span>Included</span>
            </div>
            {% endif %}
            <div class="price-total">
              <span>Total Amount</span>
              <span>${{ total_price }}</span>
            </div>
          </div>

          <!-- Security Badge -->
          <div class="security-badge">
            <div class="badge-text">
              <strong>Secure Payment</strong>
              <span>Your information is encrypted and secure</span>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script>
// Initialize Stripe
const stripe = Stripe('{{ stripe_publishable_key }}');

// Create an instance of Elements
const elements = stripe.elements();

// Custom styling for the card element
const style = {
  base: {
    color: '#333',
    fontFamily: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',
    fontSmoothing: 'antialiased',
    fontSize: '16px',
    '::placeholder': {
      color: '#999'
    },
    backgroundColor: '#ffffff',
  },
  invalid: {
    color: '#ff4444',
    iconColor: '#ff4444'
  }
};

// Create an instance of the card Element
const cardElement = elements.create('card', {style: style});

// Mount the card Element
cardElement.mount('#card-element');

// Handle real-time validation errors
cardElement.on('change', function(event) {
  const displayError = document.getElementById('card-errors');
  if (event.error) {
    displayError.textContent = event.error.message;
  } else {
    displayError.textContent = '';
  }
});

// Handle form submission
const form = document.getElementById('bookingForm');
const submitButton = document.getElementById('submit-button');
const buttonText = document.getElementById('button-text');
const spinner = document.getElementById('spinner');

form.addEventListener('submit', async function(event) {
  event.preventDefault();

  // Check terms checkbox
  const terms = document.getElementById('terms');
  if (!terms.checked) {
    alert('Please accept the Terms & Conditions to continue.');
    return;
  }

  // Disable submit button and show loading
  submitButton.disabled = true;
  buttonText.classList.add('hidden');
  spinner.classList.remove('hidden');

  // Get form data
  // Build passenger name from first Adult's first/last name if available
  let passengerName = '';
  const firstAdultFirst = document.querySelector('[id^="adult_"][id$="_first_name"]');
  const firstAdultLast = document.querySelector('[id^="adult_"][id$="_last_name"]');
  if (firstAdultFirst && firstAdultLast) {
    passengerName = `${firstAdultFirst.value} ${firstAdultLast.value}`.trim();
  }
  const email = document.getElementById('email').value;
  const totalPrice = document.getElementById('total_price').value;

  // Validate basic inputs
  const amountNumber = parseFloat(totalPrice);
  if (!Number.isFinite(amountNumber) || amountNumber <= 0) {
    const errorElement = document.getElementById('card-errors');
    errorElement.textContent = 'Invalid total amount.';
    submitButton.disabled = false;
    buttonText.classList.remove('hidden');
    spinner.classList.add('hidden');
    return;
  }

  try {
    // Create payment intent
    const response = await fetch('/create-payment-intent', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        amount: amountNumber,
        passenger_name: passengerName || email || 'Guest',
        email: email
      })
    });

    // Parse response and handle non-OK
    const raw = await response.text();
    let data = null;
    try { data = raw ? JSON.parse(raw) : null; } catch (e) { data = null; }
    if (!response.ok || !data || !data.clientSecret) {
      const errorMsg = (data && data.error) ? data.error : 'Unable to initialize payment. Please try again.';
      const errorElement = document.getElementById('card-errors');
      errorElement.textContent = errorMsg;
      submitButton.disabled = false;
      buttonText.classList.remove('hidden');
      spinner.classList.add('hidden');
      return;
    }

    const clientSecret = data.clientSecret;

    // Confirm the payment
    const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
      payment_method: {
        card: cardElement,
        billing_details: {
          name: passengerName,
          email: email
        }
      }
    });

    if (error) {
      // Show error to customer
      const errorElement = document.getElementById('card-errors');
      errorElement.textContent = error.message;
      
      // Re-enable button
      submitButton.disabled = false;
      buttonText.classList.remove('hidden');
      spinner.classList.add('hidden');
    } else {
      // Payment succeeded!
      if (paymentIntent.status === 'succeeded') {
        // Create a form to submit to confirmation page
        const confirmForm = document.createElement('form');
        confirmForm.method = 'POST';
        confirmForm.action = '/confirmation';
        
        // Collect passenger details including nationalities
        const passengers = [];
        function collectFor(prefix) {
          const nodes = document.querySelectorAll(`[id^="${prefix}_"][id$="_nationality"]`);
          nodes.forEach(sel => {
            // id pattern: prefix_index_nationality
            const id = sel.id; // e.g., adult_0_nationality
            const parts = id.split('_');
            const type = parts[0];
            const index = parts[1];
            const first = document.getElementById(`${type}_${index}_first_name`);
            const last = document.getElementById(`${type}_${index}_last_name`);
            const dob = document.getElementById(`${type}_${index}_dob`);
            const passport = document.getElementById(`${type}_${index}_passport`);
            passengers.push({
              type,
              index: Number(index),
              first_name: first ? first.value : '',
              last_name: last ? last.value : '',
              dob: dob ? dob.value : '',
              passport: passport ? passport.value : '',
              nationality: sel.value || ''
            });
          });
        }
        collectFor('adult');
        collectFor('child');
        collectFor('infant');

        // Add all the necessary fields
        const fields = {
          'passenger_name': passengerName,
          'email': email,
          'phone': document.getElementById('phone').value,
          'outbound_json': document.getElementById('outbound_json').value,
          'return_json': document.getElementById('return_json')?.value || '',
          'cabin_out': document.getElementById('cabin_out').value,
          'cabin_ret': document.getElementById('cabin_ret')?.value || '',
          'total_price': totalPrice,
          'payment_intent_id': paymentIntent.id,
          'passenger_details': JSON.stringify(passengers)
        };
        
        for (const [key, value] of Object.entries(fields)) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value;
          confirmForm.appendChild(input);
        }
        
        document.body.appendChild(confirmForm);
        confirmForm.submit();
      } else {
        const errorElement = document.getElementById('card-errors');
        errorElement.textContent = 'Payment not completed. Please try another card or contact support.';
        submitButton.disabled = false;
        buttonText.classList.remove('hidden');
        spinner.classList.add('hidden');
      }
    }
  } catch (err) {
    console.error('Payment error:', err);
    const errorElement = document.getElementById('card-errors');
    errorElement.textContent = 'An error occurred during payment processing. Please try again.';
    
    // Re-enable button
    submitButton.disabled = false;
    buttonText.classList.remove('hidden');
    spinner.classList.add('hidden');
  }
});
</script>
{% endblock %}
