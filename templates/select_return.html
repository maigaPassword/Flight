{% extends "base.html" %}
{% block title %}Select Return Flight{% endblock %}

{% block content %}
<div class="flight-results-page">
    <div class="flight-results-layout">
        <!-- Sidebar -->
        <aside class="filters-sidebar">
            <div class="time-remaining-box">
                <h4>Time Remaining</h4>
                <div id="searchTimer" class="search-timer" aria-live="polite">15:00</div>
            </div>
            <!-- Removed sidebar Stops filter (replaced by top sorting-bar dropdown) -->
            <div class="price-range">
                <div class="price-head"><h4>Price Range</h4><div class="price-values"><span id="priceMin">$0</span><span id="priceMax">$0</span></div></div>
                <input type="range" id="priceSlider" min="0" max="0" value="0" step="1" />
            </div>
        </aside>

        <main class="results-main">
            <h2 style="text-align: center; color: #00c8ff; margin-bottom: 2rem;">Select Return Flight — {{ destination }} → {{ origin }}</h2>

            {% if not return_flights or return_flights|length == 0 %}
                <p style="text-align: center;">No return flights available for the selected date. <a href="/search?origin={{ origin }}&destination={{ destination }}&date={{ return_date }}&trip_type=roundtrip&return_date={{ return_date }}">Try a different day</a>.</p>
            {% else %}
                <!-- Sorting Bar -->
                <div class="sorting-bar" role="group" aria-label="Sort flights">
                    <button type="button" class="sort-btn active" data-sort="asc">Lowest to Higher</button>
                    <button type="button" class="sort-btn" data-sort="desc">Highest to Lower</button>
                    <!-- Stops dropdown beside sort buttons -->
                    <div class="stops-dropdown" style="position: relative; display: inline-block; margin-left: 0.75rem;">
                        <button type="button" id="stopsDropdownBtn" class="sort-btn" aria-haspopup="true" aria-expanded="false">Stops: All ▾</button>
                        <div id="stopsDropdownMenu" class="stops-menu" hidden
                            style="position: absolute; top: 110%; right: 0; background: #ffffff; border: 2px solid #48cae4; border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.2); min-width: 180px; z-index: 10000;">
                            <button type="button" class="stops-option" data-stops="all" style="display:block; width:100%; text-align:left; padding:10px 12px; background:none; border:0; cursor:pointer;">All</button>
                            <button type="button" class="stops-option" data-stops="direct" style="display:block; width:100%; text-align:left; padding:10px 12px; background:none; border:0; cursor:pointer;">Direct</button>
                            <button type="button" class="stops-option" data-stops="1" style="display:block; width:100%; text-align:left; padding:10px 12px; background:none; border:0; cursor:pointer;">1 Stop</button>
                        </div>
                    </div>
                </div>

                <div id="flightsList" class="flights-list" aria-live="polite">
                    {% for r in return_flights %}
                    {% set lowest_price = r.fares_by_cabin.values() | map(attribute=0) | map(attribute='price') | min %}
                    <article class="flight-card" data-price="{{ lowest_price }}" data-stops="{{ r.stops_text }}" data-flight='{{ r | tojson | safe }}'>
                        <div class="card-grid">
                            <div class="card-main">
                                <div class="rail-itinerary" aria-label="Departure and arrival summary">
                                    <div class="rail-side origin">
                                        <div class="code">{{ r.origin }}</div>
                                        <div class="time">{{ r.departure[11:16] if r.departure else r.depart_time }}</div>
                                        <div class="airport">{{ AIRPORTS.get(r.origin, {}).get('city', '') }} ({{ r.origin }})</div>
                                    </div>
                                    <div class="rail-center" aria-hidden="true">
                                        <div class="rail-line"><span class="dot"></span><span class="bar"></span><span class="dot"></span></div>
                                        <div class="meta">{{ r.duration }} • {{ r.stops_text }}</div>
                                    </div>
                                    <div class="rail-side destination">
                                        <div class="code">{{ r.destination }}</div>
                                        <div class="time">{{ r.arrival[11:16] if r.arrival else r.arrive_time }}</div>
                                        <div class="airport">{{ AIRPORTS.get(r.destination, {}).get('city', '') }} ({{ r.destination }})
                                            {% if r.departure and r.arrival and r.departure[0:10] != r.arrival[0:10] %}
                                                <span class="next-day" title="Arrives different day">+1d</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="airline-meta">
                                    <div class="airline-row">{% if r.airline_logo %}<img src="{{ r.airline_logo }}" alt="{{ r.airline_name }}" class="airline-icon">{% endif %}<span class="airline-name">{{ r.airline_name }}</span></div>
                                    <div class="flight-number">Offer #{{ r.offer_id }}</div>
                                    <div class="route-text">{{ r.origin }}–{{ r.destination }}</div>
                                </div>
                            </div>
                            <div class="card-actions">
                                <div class="price-line">From <strong class="price-amount">USD {{ '%.2f'|format(lowest_price) }}</strong></div>
                                <button type="button" class="details-toggle-btn" aria-expanded="false" aria-controls="details-{{ loop.index }}">Details</button>
                                <button type="button" class="select-flight-btn" data-flight-index="{{ loop.index }}" data-flight='{{ r | tojson | safe }}'>Select Return</button>
                            </div>
                        </div>
                        <div class="flight-card-details" id="details-{{ loop.index }}" hidden>
                            <div class="details-inner">
                                <div class="details-header-row">
                                    <span class="details-title">Flight Details</span>
                                    <span class="details-duration"><strong>Duration:</strong> {{ r.duration }}</span>
                                    <span class="details-stops"><strong>Stops:</strong> {{ r.stops_text }}</span>
                                </div>
                                {% if r.segments %}
                                <ul class="segment-breakdown">
                                    {% for seg in r.segments %}
                                    <li class="segment-row">
                                        <div class="seg-times">
                                            <span class="seg-dep">
                                                <strong>{{ seg.origin }}</strong>
                                                <span class="seg-city" data-code="{{ seg.origin }}"></span>
                                                {{ seg.departure }}
                                            </span>
                                            <span class="seg-arrow">→</span>
                                            <span class="seg-arr">
                                                <strong>{{ seg.destination }}</strong>
                                                <span class="seg-city" data-code="{{ seg.destination }}"></span>
                                                {{ seg.arrival }}
                                            </span>
                                        </div>
                                        <div class="seg-meta">
                                            {% if seg.duration %}<span class="seg-leg-dur">{{ seg.duration }}</span>{% endif %}
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                                <div class="details-footer-row">
                                    <span class="detail-note">All times local • Prices subject to availability</span>
                                </div>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>
            {% endif %}
        </main>
    </div>
</div>

<!-- Cabin Selection Modal -->
<div id="cabinModal" class="cabin-modal" hidden>
    <div class="cabin-modal-overlay"></div>
    <div class="cabin-modal-content">
        <div class="cabin-modal-header">
            <h2>Select Cabin Class</h2>
            <button class="cabin-close-btn" aria-label="Close">&times;</button>
        </div>
        <div class="cabin-modal-body">
            <p class="cabin-instruction">Choose your preferred cabin class for the return flight:</p>
            <div id="cabinOptions" class="cabin-options"></div>
        </div>
        <form id="cabinSelectionForm" method="POST" action="/flight_summary" hidden>
            <input type="hidden" name="outbound_json" value='{{ outbound_json }}'>
            <input type="hidden" name="return_json" id="selectedReturnJson" value=''>
            <input type="hidden" name="cabin_out" value="{{ cabin_out }}">
            <input type="hidden" name="cabin_ret" id="selectedCabinRet" value="">
        </form>
    </div>
</div>

<div id="flightModal" class="flight-modal" hidden>
    <div class="flight-modal-content">
        <button class="flight-close-btn" aria-label="Close">&times;</button>
        <div id="flightModalBody"></div>
    </div>
</div>

<script>
    window.AIRPORTS = {{ AIRPORTS | tojson | safe }};
    window.COUNTRY_NAMES = {{ COUNTRY_NAMES | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/select_return.js') }}"></script>
{% endblock %}
