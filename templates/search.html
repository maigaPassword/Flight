{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
<style>
/* Use the same big-screen form style as the Home page (glassmorphism) */
/* Return date field - always visible but disabled for one-way */
#return-date-wrapper {
    display: flex !important;
    flex-direction: column !important;
    gap: 0.5rem !important;
    flex: 1 1 200px !important;
    min-width: 200px !important;
    position: relative !important;
    z-index: 10 !important;
    opacity: 0.5 !important;
    pointer-events: none !important;
    transition: opacity 0.3s ease, filter 0.3s ease !important;
}
#return-date-wrapper.visible {
    opacity: 1 !important;
    pointer-events: auto !important;
}
#return-date-wrapper:not(.visible) label {
    color: rgba(255, 255, 255, 0.6) !important;
}
#return-date-wrapper:not(.visible) input {
    background: linear-gradient(135deg, rgba(3, 4, 94, 0.3) 0%, rgba(0, 119, 182, 0.2) 100%) !important;
    border-color: rgba(72, 202, 228, 0.15) !important;
    cursor: not-allowed !important;
}

/* Autocomplete input and dropdown fixes */
.form-field.autocomplete {
    position: relative !important;
    z-index: 100 !important;
    overflow: visible !important;
}
.form-field.autocomplete:focus-within {
    z-index: 10000 !important;
}
.form-field.autocomplete input[type="text"] {
    background: rgba(255, 255, 255, 0.95) !important;
    color: #03045e !important;
    font-weight: 600 !important;
}
.form-field.autocomplete input[type="text"]:focus {
    background: #ffffff !important;
    color: #03045e !important;
    border-color: #48cae4 !important;
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2) !important;
}
.form-field.autocomplete input[type="text"]::placeholder {
    color: rgba(3, 4, 94, 0.5) !important;
}

/* Ensure autocomplete dropdown is visible */
.airport-dropdown {
    position: absolute !important;
    z-index: 999999 !important;
    display: none !important;
}
.airport-dropdown[style*="display: block"] {
    display: block !important;
}

/* Ensure the top form doesn't clip dropdown */
.hero-search-form { overflow: visible !important; }
.hero-search-form .form-field { overflow: visible !important; }

/* Ensure results-main and entire layout allows overflow */
.results-main {
    overflow: visible !important;
}
.flight-results-layout {
    overflow: visible !important;
}

/* Adjust card-actions button layout */
.card-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}
/* Left-align sorting bar controls */
.sorting-bar { justify-content: flex-start; }

/* Compact the search form on smaller screens (search page specific) */
@media (max-width: 1024px) {
    .results-main .hero-search-form {
        padding: 1.5rem 1.25rem;
        border-radius: 16px;
    }
    .results-main .hero-search-form .form-grid {
        gap: 1rem;
    }
    .results-main .hero-search-form .form-field label {
        font-size: 0.85rem;
        letter-spacing: 0.3px;
    }
    .results-main .hero-search-form .form-field input,
    .results-main .hero-search-form .form-field select {
        padding: 0.9rem 1rem;
        font-size: 0.975rem;
    }
    .results-main .hero-search-form .search-btn {
        min-width: 220px;
        padding: 0.9rem 1.25rem;
        font-size: 1rem;
    }
}

@media (max-width: 768px) {
    .results-main .hero-search-form {
        padding: 1.25rem 1rem;
        border-radius: 14px;
    }
    .results-main .hero-search-form .form-grid {
        gap: 0.75rem;
    }
    .results-main .hero-search-form .form-field {
        min-width: 100%;
    }
    .results-main .hero-search-form .form-field label {
        font-size: 0.8rem;
    }
    .results-main .hero-search-form .form-field input,
    .results-main .hero-search-form .form-field select {
        padding: 0.8rem 0.9rem;
        font-size: 0.95rem;
        border-radius: 10px;
    }
    .results-main .hero-search-form .search-btn {
        min-width: 200px;
        padding: 0.85rem 1.1rem;
        font-size: 0.975rem;
        border-radius: 10px;
    }
}

@media (max-width: 480px) {
    .results-main .hero-search-form {
        padding: 1rem 0.75rem;
        border-radius: 12px;
    }
    .results-main .hero-search-form .form-header {
        margin-bottom: 1rem;
    }
    .results-main .hero-search-form .trip-type-selector {
        gap: 0.5rem;
    }
    .results-main .hero-search-form .trip-option {
        padding: 0.5rem 0.9rem;
        border-radius: 10px;
    }
    .results-main .hero-search-form .form-grid {
        gap: 0.6rem;
    }
    .results-main .hero-search-form .form-field label {
        font-size: 0.75rem;
    }
    .results-main .hero-search-form .form-field input,
    .results-main .hero-search-form .form-field select {
        padding: 0.7rem 0.8rem;
        font-size: 0.9rem;
        border-radius: 8px;
    }
    .results-main .hero-search-form .search-btn {
        min-width: 180px;
        padding: 0.8rem 1rem;
        font-size: 0.95rem;
        border-radius: 8px;
    }
}
</style>
<div class="flight-results-page">
    <div class="flight-results-layout">
        <!-- Sidebar -->
            <aside class="filters-sidebar">
            <!-- Search Form moved out of sidebar to top: removed here -->
            
            <div class="time-remaining-box">
                <h4>Time Remaining</h4>
                <div id="searchTimer" class="search-timer" aria-live="polite">15:00</div>
            </div>
            
            <!-- Removed sidebar Stops filter (replaced by top sorting-bar dropdown) -->
            
            <div class="price-range">
                <div class="price-head"><h4>Price Range</h4><div class="price-values"><span id="priceMin">$0</span><span id="priceMax">$0</span></div></div>
                <input type="range" id="priceSlider" min="0" max="0" value="0" step="1" />
            </div>
        </aside>
            <main class="results-main">
                <!-- Top Modify Search styled exactly like Home hero form on big screens -->
            <div class="hero-search-wrapper">
                <form id="flightForm" method="POST" action="/search" class="hero-search-form">
                    <div class="form-header">
                        <div class="trip-type-selector">
                            <label class="trip-option">
                                <input type="radio" name="trip_type" id="trip_type_oneway" value="oneway" {% if (trip_type or 'oneway') == 'oneway' %}checked{% endif %}
                                       onchange="document.getElementById('return-date-wrapper').classList.remove('visible'); document.getElementById('return_date').required = false;">
                                <span>One-way</span>
                            </label>
                            <label class="trip-option">
                                <input type="radio" name="trip_type" id="trip_type_roundtrip" value="roundtrip" {% if (trip_type or '') == 'roundtrip' %}checked{% endif %}
                                       onchange="document.getElementById('return-date-wrapper').classList.add('visible'); document.getElementById('return_date').required = true;">
                                <span>Round-trip</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-field autocomplete">
                            <label for="origin">From</label>
                            <input type="text" name="origin" id="origin" placeholder="Origin airport" required autocomplete="off">
                        </div>

                        <div class="form-field autocomplete">
                            <label for="destination">To</label>
                            <input type="text" name="destination" id="destination" placeholder="Destination airport" required autocomplete="off">
                        </div>

                        <div class="form-field">
                            <label for="date">Departure</label>
                            <input type="date" name="date" id="date" value="{{ searched_date }}" required>
                        </div>

                        <div class="form-field" id="return-date-wrapper">
                            <label for="return_date">Return</label>
                            <input type="date" name="return_date" id="return_date" value="{{ return_date or '' }}">
                        </div>
                    </div>

                    <!-- Hidden fields to store selected IATA codes from autocomplete -->
                    <input type="hidden" name="origin_code" id="origin_code" value="">
                    <input type="hidden" name="destination_code" id="destination_code" value="">

                    <div class="form-actions">
                        <button type="submit" class="search-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            Search Flights
                        </button>
                    </div>
                </form>
            </div>
                <!-- Sorting Bar -->
            <div class="sorting-bar" role="group" aria-label="Sort flights">
                <button type="button" class="sort-btn active" data-sort="asc">Lowest to Higher</button>
                <button type="button" class="sort-btn" data-sort="desc">Highest to Lower</button>
                <!-- Stops dropdown beside sort buttons -->
                <div class="stops-dropdown" style="position: relative; display: inline-block; margin-left: 0.5rem;">
                    <button type="button" id="stopsDropdownBtn" class="sort-btn" aria-haspopup="true" aria-expanded="false">Stops: All ▾</button>
                    <div id="stopsDropdownMenu" class="stops-menu" hidden
                        style="position: absolute; top: 110%; right: 0; background: #ffffff; border: 2px solid #48cae4; border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.2); min-width: 200px; z-index: 10000;">
                        <!-- Options will be generated dynamically based on available flights -->
                    </div>
                </div>
            </div>
            <div id="flightsList" class="flights-list" aria-live="polite">
                {% for flight in flights %}
                {% set lowest_price = flight.fares_by_cabin.values() | map(attribute=0) | map(attribute='price') | min %}
                <article class="flight-card" data-price="{{ lowest_price }}" data-stops="{{ flight.stops_text }}" data-flight='{{ flight | tojson | safe }}'>
                    <div class="card-grid">
                        <div class="card-main">
                            <div class="rail-itinerary" aria-label="Departure and arrival summary">
                                <div class="rail-side origin">
                                    <div class="code">{{ flight.origin }}</div>
                                    <div class="time">{{ flight.departure[11:16] if flight.departure else flight.depart_time }}</div>
                                    <div class="airport">{{ AIRPORTS.get(flight.origin, {}).get('city', '') }} ({{ flight.origin }})</div>
                                </div>
                                <div class="rail-center" aria-hidden="true">
                                    <div class="rail-line"><span class="dot"></span><span class="bar"></span><span class="dot"></span></div>
                                    <div class="meta">{{ flight.duration }} • {{ flight.stops_text }}</div>
                                </div>
                                <div class="rail-side destination">
                                    <div class="code">{{ flight.destination }}</div>
                                    <div class="time">{{ flight.arrival[11:16] if flight.arrival else flight.arrive_time }}</div>
                                    <div class="airport">{{ AIRPORTS.get(flight.destination, {}).get('city', '') }} ({{ flight.destination }})
                                        {% if flight.departure and flight.arrival and flight.departure[0:10] != flight.arrival[0:10] %}
                                            <span class="next-day" title="Arrives different day">+1d</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="airline-meta">
                                <div class="airline-row">{% if flight.airline_logo %}<img src="{{ flight.airline_logo }}" alt="{{ flight.airline_name }}" class="airline-icon">{% endif %}<span class="airline-name">{{ flight.airline_name }}</span></div>
                                <div class="flight-number">Offer #{{ flight.offer_id }}</div>
                                <div class="route-text">{{ flight.origin }}–{{ flight.destination }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <div class="price-line">From <strong class="price-amount">USD {{ '%.2f'|format(lowest_price) }}</strong></div>
                            <button type="button" class="details-toggle-btn" aria-expanded="false" aria-controls="details-{{ loop.index }}">Details</button>
                            {% if (trip_type or 'oneway') == 'roundtrip' %}
                            <button type="button" class="select-outbound-btn" 
                                    data-flight-index="{{ loop.index }}" 
                                    data-flight='{{ flight | tojson | safe }}'
                                    data-origin="{{ origin }}"
                                    data-destination="{{ destination }}"
                                    data-return-date="{{ return_date }}">Select Flight</button>
                            {% else %}
                            <button type="button" class="select-oneway-btn" 
                                    data-flight-index="{{ loop.index }}" 
                                    data-flight='{{ flight | tojson | safe }}'>Select Flight</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flight-card-details" id="details-{{ loop.index }}" hidden>
                        <div class="details-inner">
                            <div class="details-header-row">
                                <span class="details-title">Flight Details</span>
                                <span class="details-duration"><strong>Duration:</strong> {{ flight.duration }}</span>
                                <span class="details-stops"><strong>Stops:</strong> {{ flight.stops_text }}</span>
                            </div>
                            {% if flight.segments %}
                            <ul class="segment-breakdown">
                                {% for seg in flight.segments %}
                                <li class="segment-row">
                                    <div class="seg-times">
                                        <span class="seg-dep">
                                            <strong>{{ seg.origin }}</strong>
                                            <span class="seg-city" data-code="{{ seg.origin }}"></span>
                                            {{ seg.departure }}
                                        </span>
                                        <span class="seg-arrow">→</span>
                                        <span class="seg-arr">
                                            <strong>{{ seg.destination }}</strong>
                                            <span class="seg-city" data-code="{{ seg.destination }}"></span>
                                            {{ seg.arrival }}
                                        </span>
                                    </div>
                                    <div class="seg-meta">
                                        {% if seg.duration %}<span class="seg-leg-dur">{{ seg.duration }}</span>{% endif %}
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                            <div class="details-footer-row">
                                <span class="detail-note">All times local • Prices subject to availability</span>
                            </div>
                        </div>
                    </div>
                </article>
                {% endfor %}
                
                {% if flights|length == 0 %}
                <div style="text-align: center; padding: 4rem 2rem; color: #666;">
                    <h2 style="color: #0077b6; margin-bottom: 1rem;">No flights found</h2>
                    <p>Try searching for different airports or dates.</p>
                    <p style="margin-top: 1rem;"><strong>Debug Info:</strong><br>
                    Origin: {{ origin or 'Not set' }}<br>
                    Destination: {{ destination or 'Not set' }}<br>
                    Date: {{ searched_date or 'Not set' }}</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>

<!-- Cabin Selection Modal -->
<div id="cabinModal" class="cabin-modal" hidden>
    <div class="cabin-modal-overlay"></div>
    <div class="cabin-modal-content">
        <div class="cabin-modal-header">
            <h2>Select Cabin Class</h2>
            <button class="cabin-close-btn" aria-label="Close">&times;</button>
        </div>
        <div class="cabin-modal-body">
            <p class="cabin-instruction">Choose your preferred cabin class for this flight:</p>
            <div id="cabinOptions" class="cabin-options"></div>
        </div>
        <form id="cabinOutboundForm" method="POST" action="/select_return" hidden>
            <input type="hidden" name="outbound_json" id="selectedOutboundJson" value=''>
            <input type="hidden" name="cabin_out" id="selectedCabinOut" value="">
            <input type="hidden" name="origin" id="formOrigin" value="">
            <input type="hidden" name="destination" id="formDestination" value="">
            <input type="hidden" name="return_date" id="formReturnDate" value="">
        </form>
        <form id="cabinOnewayForm" method="POST" action="/flight_summary" hidden>
            <input type="hidden" name="outbound_json" id="selectedOnewayJson" value=''>
            <input type="hidden" name="cabin_out" id="selectedCabinOneway" value="">
        </form>
    </div>
</div>

<div id="flightModal" class="flight-modal" hidden>
    <div class="flight-modal-content">
        <button class="flight-close-btn" aria-label="Close">&times;</button>
        <div id="flightModalBody"></div>
    </div>
</div>
<script>
    window.AIRPORTS = {{ AIRPORTS | tojson | safe }};
    window.COUNTRY_NAMES = {{ COUNTRY_NAMES | tojson | safe }};
    // Data injected; page logic loaded below
    </script>
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
{% endblock %}
