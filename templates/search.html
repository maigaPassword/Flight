{% extends "base.html" %}
{% block content %}
<style>
/* Use the same big-screen form style as the Home page (glassmorphism) */
/* Return date field - always visible but disabled for one-way */
#return-date-wrapper {
    display: flex !important;
    flex-direction: column !important;
    gap: 0.5rem !important;
    flex: 1 1 200px !important;
    min-width: 200px !important;
    position: relative !important;
    z-index: 10 !important;
    opacity: 0.5 !important;
    pointer-events: none !important;
    transition: opacity 0.3s ease, filter 0.3s ease !important;
}
#return-date-wrapper.visible {
    opacity: 1 !important;
    pointer-events: auto !important;
}
#return-date-wrapper:not(.visible) label {
    color: rgba(255, 255, 255, 0.6) !important;
}
#return-date-wrapper:not(.visible) input {
    background: linear-gradient(135deg, rgba(3, 4, 94, 0.3) 0%, rgba(0, 119, 182, 0.2) 100%) !important;
    border-color: rgba(72, 202, 228, 0.15) !important;
    cursor: not-allowed !important;
}

/* Autocomplete input and dropdown fixes */
.form-field.autocomplete {
    position: relative !important;
    z-index: 100 !important;
    overflow: visible !important;
}
.form-field.autocomplete:focus-within {
    z-index: 10000 !important;
}
.form-field.autocomplete input[type="text"] {
    background: rgba(255, 255, 255, 0.95) !important;
    color: #03045e !important;
    font-weight: 600 !important;
}
.form-field.autocomplete input[type="text"]:focus {
    background: #ffffff !important;
    color: #03045e !important;
    border-color: #48cae4 !important;
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2) !important;
}
.form-field.autocomplete input[type="text"]::placeholder {
    color: rgba(3, 4, 94, 0.5) !important;
}

/* Ensure autocomplete dropdown is visible */
.airport-dropdown {
    position: absolute !important;
    z-index: 999999 !important;
    display: none !important;
}
.airport-dropdown[style*="display: block"] {
    display: block !important;
}

/* Ensure the top form doesn't clip dropdown */
.hero-search-form { overflow: visible !important; }
.hero-search-form .form-field { overflow: visible !important; }

/* Ensure results-main and entire layout allows overflow */
.results-main {
    overflow: visible !important;
}
.flight-results-layout {
    overflow: visible !important;
}

/* Adjust card-actions button layout */
.card-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}
/* Left-align sorting bar controls */
.sorting-bar { justify-content: flex-start; }

/* Compact the search form on smaller screens (search page specific) */
@media (max-width: 1024px) {
    .results-main .hero-search-form {
        padding: 1.5rem 1.25rem;
        border-radius: 16px;
    }
    .results-main .hero-search-form .form-grid {
        gap: 1rem;
    }
    .results-main .hero-search-form .form-field label {
        font-size: 0.85rem;
        letter-spacing: 0.3px;
    }
    .results-main .hero-search-form .form-field input,
    .results-main .hero-search-form .form-field select {
        padding: 0.9rem 1rem;
        font-size: 0.975rem;
    }
    .results-main .hero-search-form .search-btn {
        min-width: 220px;
        padding: 0.9rem 1.25rem;
        font-size: 1rem;
    }
}

@media (max-width: 768px) {
    .results-main .hero-search-form {
        padding: 1.25rem 1rem;
        border-radius: 14px;
    }
    .results-main .hero-search-form .form-grid {
        gap: 0.75rem;
    }
    .results-main .hero-search-form .form-field {
        min-width: 100%;
    }
    .results-main .hero-search-form .form-field label {
        font-size: 0.8rem;
    }
    .results-main .hero-search-form .form-field input,
    .results-main .hero-search-form .form-field select {
        padding: 0.8rem 0.9rem;
        font-size: 0.95rem;
        border-radius: 10px;
    }
    .results-main .hero-search-form .search-btn {
        min-width: 200px;
        padding: 0.85rem 1.1rem;
        font-size: 0.975rem;
        border-radius: 10px;
    }
}

@media (max-width: 480px) {
    .results-main .hero-search-form {
        padding: 1rem 0.75rem;
        border-radius: 12px;
    }
    .results-main .hero-search-form .form-header {
        margin-bottom: 1rem;
    }
    .results-main .hero-search-form .trip-type-selector {
        gap: 0.5rem;
    }
    .results-main .hero-search-form .trip-option {
        padding: 0.5rem 0.9rem;
        border-radius: 10px;
    }
    .results-main .hero-search-form .form-grid {
        gap: 0.6rem;
    }
    .results-main .hero-search-form .form-field label {
        font-size: 0.75rem;
    }
    .results-main .hero-search-form .form-field input,
    .results-main .hero-search-form .form-field select {
        padding: 0.7rem 0.8rem;
        font-size: 0.9rem;
        border-radius: 8px;
    }
    .results-main .hero-search-form .search-btn {
        min-width: 180px;
        padding: 0.8rem 1rem;
        font-size: 0.95rem;
        border-radius: 8px;
    }
}
</style>
<div class="flight-results-page">
    <div class="flight-results-layout">
        <!-- Sidebar -->
            <aside class="filters-sidebar">
            <!-- Search Form moved out of sidebar to top: removed here -->
            
            <div class="time-remaining-box">
                <h4>Time Remaining</h4>
                <div id="searchTimer" class="search-timer" aria-live="polite">15:00</div>
            </div>
            
            <!-- Removed sidebar Stops filter (replaced by top sorting-bar dropdown) -->
            
            <div class="price-range">
                <div class="price-head"><h4>Price Range</h4><div class="price-values"><span id="priceMin">$0</span><span id="priceMax">$0</span></div></div>
                <input type="range" id="priceSlider" min="0" max="0" value="0" step="1" />
            </div>
        </aside>
            <main class="results-main">
                <!-- Top Modify Search styled exactly like Home hero form on big screens -->
            <div class="hero-search-wrapper">
                <form id="flightForm" method="POST" action="/search" class="hero-search-form">
                    <div class="form-header">
                        <div class="trip-type-selector">
                            <label class="trip-option">
                                <input type="radio" name="trip_type" id="trip_type_oneway" value="oneway" {% if (trip_type or 'oneway') == 'oneway' %}checked{% endif %}
                                       onchange="document.getElementById('return-date-wrapper').classList.remove('visible'); document.getElementById('return_date').required = false;">
                                <span>One-way</span>
                            </label>
                            <label class="trip-option">
                                <input type="radio" name="trip_type" id="trip_type_roundtrip" value="roundtrip" {% if (trip_type or '') == 'roundtrip' %}checked{% endif %}
                                       onchange="document.getElementById('return-date-wrapper').classList.add('visible'); document.getElementById('return_date').required = true;">
                                <span>Round-trip</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-field autocomplete">
                            <label for="origin">From</label>
                            <input type="text" name="origin" id="origin" placeholder="Origin airport" required autocomplete="off">
                        </div>

                        <div class="form-field autocomplete">
                            <label for="destination">To</label>
                            <input type="text" name="destination" id="destination" placeholder="Destination airport" required autocomplete="off">
                        </div>

                        <div class="form-field">
                            <label for="date">Departure</label>
                            <input type="date" name="date" id="date" value="{{ searched_date }}" required>
                        </div>

                        <div class="form-field" id="return-date-wrapper">
                            <label for="return_date">Return</label>
                            <input type="date" name="return_date" id="return_date" value="{{ return_date or '' }}">
                        </div>
                    </div>

                    <!-- Hidden fields to store selected IATA codes from autocomplete -->
                    <input type="hidden" name="origin_code" id="origin_code" value="">
                    <input type="hidden" name="destination_code" id="destination_code" value="">

                    <div class="form-actions">
                        <button type="submit" class="search-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            Search Flights
                        </button>
                    </div>
                </form>
            </div>
                <!-- Sorting Bar -->
            <div class="sorting-bar" role="group" aria-label="Sort flights">
                <button type="button" class="sort-btn active" data-sort="asc">Lowest to Higher</button>
                <button type="button" class="sort-btn" data-sort="desc">Highest to Lower</button>
                <!-- Stops dropdown beside sort buttons -->
                <div class="stops-dropdown" style="position: relative; display: inline-block; margin-left: 0.5rem;">
                    <button type="button" id="stopsDropdownBtn" class="sort-btn" aria-haspopup="true" aria-expanded="false">Stops: All ‚ñæ</button>
                    <div id="stopsDropdownMenu" class="stops-menu" hidden
                        style="position: absolute; top: 110%; right: 0; background: #ffffff; border: 2px solid #48cae4; border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.2); min-width: 200px; z-index: 10000;">
                        <!-- Options will be generated dynamically based on available flights -->
                    </div>
                </div>
            </div>
            <div id="flightsList" class="flights-list" aria-live="polite">
                {% for flight in flights %}
                {% set lowest_price = flight.fares_by_cabin.values() | map(attribute=0) | map(attribute='price') | min %}
                <article class="flight-card" data-price="{{ lowest_price }}" data-stops="{{ flight.stops_text }}" data-flight='{{ flight | tojson | safe }}'>
                    <div class="card-grid">
                        <div class="card-main">
                            <div class="rail-itinerary" aria-label="Departure and arrival summary">
                                <div class="rail-side origin">
                                    <div class="code">{{ flight.origin }}</div>
                                    <div class="time">{{ flight.departure[11:16] if flight.departure else flight.depart_time }}</div>
                                    <div class="airport">{{ AIRPORTS.get(flight.origin, {}).get('city', '') }} ({{ flight.origin }})</div>
                                </div>
                                <div class="rail-center" aria-hidden="true">
                                    <div class="rail-line"><span class="dot"></span><span class="bar"></span><span class="dot"></span></div>
                                    <div class="meta">{{ flight.duration }} ‚Ä¢ {{ flight.stops_text }}</div>
                                </div>
                                <div class="rail-side destination">
                                    <div class="code">{{ flight.destination }}</div>
                                    <div class="time">{{ flight.arrival[11:16] if flight.arrival else flight.arrive_time }}</div>
                                    <div class="airport">{{ AIRPORTS.get(flight.destination, {}).get('city', '') }} ({{ flight.destination }})
                                        {% if flight.departure and flight.arrival and flight.departure[0:10] != flight.arrival[0:10] %}
                                            <span class="next-day" title="Arrives different day">+1d</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="airline-meta">
                                <div class="airline-row">{% if flight.airline_logo %}<img src="{{ flight.airline_logo }}" alt="{{ flight.airline_name }}" class="airline-icon">{% endif %}<span class="airline-name">{{ flight.airline_name }}</span></div>
                                <div class="flight-number">Offer #{{ flight.offer_id }}</div>
                                <div class="route-text">{{ flight.origin }}‚Äì{{ flight.destination }}</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <div class="price-line">From <strong class="price-amount">USD {{ '%.2f'|format(lowest_price) }}</strong></div>
                            <button type="button" class="details-toggle-btn" aria-expanded="false" aria-controls="details-{{ loop.index }}">Details</button>
                            {% if (trip_type or 'oneway') == 'roundtrip' %}
                            <button type="button" class="select-outbound-btn" 
                                    data-flight-index="{{ loop.index }}" 
                                    data-flight='{{ flight | tojson | safe }}'
                                    data-origin="{{ origin }}"
                                    data-destination="{{ destination }}"
                                    data-return-date="{{ return_date }}">Select Flight</button>
                            {% else %}
                            <button type="button" class="select-oneway-btn" 
                                    data-flight-index="{{ loop.index }}" 
                                    data-flight='{{ flight | tojson | safe }}'>Select Flight</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flight-card-details" id="details-{{ loop.index }}" hidden>
                        <div class="details-inner">
                            <div class="details-header-row">
                                <span class="details-title">Flight Details</span>
                                <span class="details-duration"><strong>Duration:</strong> {{ flight.duration }}</span>
                                <span class="details-stops"><strong>Stops:</strong> {{ flight.stops_text }}</span>
                            </div>
                            {% if flight.segments %}
                            <ul class="segment-breakdown">
                                {% for seg in flight.segments %}
                                <li class="segment-row">
                                    <div class="seg-times">
                                        <span class="seg-dep">
                                            <strong>{{ seg.origin }}</strong>
                                            <span class="seg-city" data-code="{{ seg.origin }}"></span>
                                            {{ seg.departure }}
                                        </span>
                                        <span class="seg-arrow">‚Üí</span>
                                        <span class="seg-arr">
                                            <strong>{{ seg.destination }}</strong>
                                            <span class="seg-city" data-code="{{ seg.destination }}"></span>
                                            {{ seg.arrival }}
                                        </span>
                                    </div>
                                    <div class="seg-meta">
                                        {% if seg.duration %}<span class="seg-leg-dur">{{ seg.duration }}</span>{% endif %}
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                            <div class="details-footer-row">
                                <span class="detail-note">All times local ‚Ä¢ Prices subject to availability</span>
                            </div>
                        </div>
                    </div>
                </article>
                {% endfor %}
                
                {% if flights|length == 0 %}
                <div style="text-align: center; padding: 4rem 2rem; color: #666;">
                    <h2 style="color: #0077b6; margin-bottom: 1rem;">No flights found</h2>
                    <p>Try searching for different airports or dates.</p>
                    <p style="margin-top: 1rem;"><strong>Debug Info:</strong><br>
                    Origin: {{ origin or 'Not set' }}<br>
                    Destination: {{ destination or 'Not set' }}<br>
                    Date: {{ searched_date or 'Not set' }}</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>

<!-- Cabin Selection Modal -->
<div id="cabinModal" class="cabin-modal" hidden>
    <div class="cabin-modal-overlay"></div>
    <div class="cabin-modal-content">
        <div class="cabin-modal-header">
            <h2>Select Cabin Class</h2>
            <button class="cabin-close-btn" aria-label="Close">&times;</button>
        </div>
        <div class="cabin-modal-body">
            <p class="cabin-instruction">Choose your preferred cabin class for this flight:</p>
            <div id="cabinOptions" class="cabin-options"></div>
        </div>
        <form id="cabinOutboundForm" method="POST" action="/select_return" hidden>
            <input type="hidden" name="outbound_json" id="selectedOutboundJson" value=''>
            <input type="hidden" name="cabin_out" id="selectedCabinOut" value="">
            <input type="hidden" name="origin" id="formOrigin" value="">
            <input type="hidden" name="destination" id="formDestination" value="">
            <input type="hidden" name="return_date" id="formReturnDate" value="">
        </form>
        <form id="cabinOnewayForm" method="POST" action="/flight_summary" hidden>
            <input type="hidden" name="outbound_json" id="selectedOnewayJson" value=''>
            <input type="hidden" name="cabin_out" id="selectedCabinOneway" value="">
        </form>
    </div>
</div>

<div id="flightModal" class="flight-modal" hidden>
    <div class="flight-modal-content">
        <button class="flight-close-btn" aria-label="Close">&times;</button>
        <div id="flightModalBody"></div>
    </div>
</div>
<script>
    console.log('üü¢ SCRIPT TAG LOADED');
    window.AIRPORTS = {{ AIRPORTS | default({}) | tojson | safe }};
    window.COUNTRY_NAMES = {{ COUNTRY_NAMES | default({}) | tojson | safe }};
    console.log('üü¢ AIRPORTS injected:', Object.keys(window.AIRPORTS).length, 'airports');
    
    // ========================================
    // AIRPORT AUTOCOMPLETE - Uses window.AIRPORTS
    // ========================================
    (function() {
        console.log('üîµ AUTOCOMPLETE FUNCTION STARTED');
        
        // Use the airports already loaded from Flask
        const airportsData = window.AIRPORTS || {};
        const airportsList = Object.keys(airportsData).map(iata => ({
            iata: iata,
            city: airportsData[iata].city || '',
            name: airportsData[iata].name || '',
            country: airportsData[iata].country || '',
        }));
        
        console.log('‚úàÔ∏è Loaded', airportsList.length, 'airports from window.AIRPORTS');
                
    // Setup autocomplete for inputs (single form moved to top)
    setupAutocomplete('origin');
    setupAutocomplete('destination');
        
        function setupAutocomplete(inputId) {
            const input = document.getElementById(inputId);
            if (!input) {
                console.log('‚ùå Input not found:', inputId);
                return;
            }
            
            console.log('‚úÖ Setting up autocomplete for:', inputId);
            
            const dropdown = document.createElement('div');
            dropdown.className = 'airport-dropdown';
            dropdown.style.cssText = `
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: #ffffff;
                border: 2px solid #48cae4;
                border-radius: 12px;
                margin-top: 4px;
                max-height: 350px;
                overflow-y: auto;
                display: none;
                z-index: 999999;
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(72, 202, 228, 0.3);
            `;
            
            input.parentElement.appendChild(dropdown);
            
            let debounceTimer;
            
            input.addEventListener('input', function() {
                const keyword = this.value.trim().toLowerCase();
                clearTimeout(debounceTimer);
                
                if (keyword.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                debounceTimer = setTimeout(() => {
                    const matches = airportsList.filter(airport => 
                        airport.iata.toLowerCase().includes(keyword) ||
                        airport.city.toLowerCase().includes(keyword) ||
                        airport.name.toLowerCase().includes(keyword)
                    ).slice(0, 8);
                    
                    dropdown.innerHTML = '';
                    
                    if (matches.length === 0) {
                        dropdown.innerHTML = `<div style="padding: 20px; text-align: center; color: #023e8a; font-weight: 500;">No airports found</div>`;
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    matches.forEach(airport => {
                        const item = document.createElement('div');
                        item.style.cssText = `
                            padding: 14px 18px;
                            cursor: pointer;
                            border-bottom: 1px solid rgba(72, 202, 228, 0.3);
                            display: flex;
                            align-items: center;
                            gap: 14px;
                            transition: all 0.3s ease;
                            background: transparent;
                        `;
                        
                        const location = airport.city + (airport.state ? `, ${airport.state}` : '') + (airport.country ? `, ${airport.country}` : '');
                        
                        item.innerHTML = `
                            <div style="
                                background: linear-gradient(135deg, #0077b6, #00b4d8);
                                border: 2px solid #48cae4;
                                border-radius: 8px;
                                padding: 8px 12px;
                                font-weight: 700;
                                color: #ffffff;
                                min-width: 50px;
                                text-align: center;
                                font-size: 0.95rem;
                                letter-spacing: 0.5px;
                                box-shadow: 0 2px 8px rgba(72, 202, 228, 0.3);
                            ">${airport.iata}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: #03045e; font-weight: 600; font-size: 0.95rem; margin-bottom: 3px;">${location}</div>
                                <div style="color: #023e8a; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.8;">${airport.name}</div>
                            </div>
                        `;
                        
                        item.onmouseenter = () => {
                            item.style.background = 'linear-gradient(135deg, rgba(72, 202, 228, 0.15), rgba(0, 180, 216, 0.1))';
                            item.style.borderLeft = '4px solid #0077b6';
                            item.style.paddingLeft = '14px';
                        };
                        item.onmouseleave = () => {
                            item.style.background = 'transparent';
                            item.style.borderLeft = 'none';
                            item.style.paddingLeft = '18px';
                        };
                        
                        item.onclick = () => {
                            // Format: "City, Country - Airport Name (CODE)"
                            const displayText = `${airport.city}${airport.country ? ', ' + airport.country : ''} - ${airport.name} (${airport.iata})`;
                            input.value = displayText;
                            
                            // Also set the hidden code field (supports sidebar and top form)
                            const codeField = document.getElementById(inputId + '_code');
                            if (codeField) {
                                codeField.value = airport.iata;
                            }
                            
                            dropdown.style.display = 'none';
                        };
                        
                        dropdown.appendChild(item);
                    });
                    
                    dropdown.style.display = 'block';
                }, 250);
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
    })();
    
    // Initialize return-date-wrapper visibility based on selected radio
    (function(){
        const wrap = document.getElementById('return-date-wrapper');
        const ret = document.getElementById('return_date');
        const isRound = document.getElementById('trip_type_roundtrip')?.checked;
        if (isRound) { wrap.classList.add('visible'); ret.required = true; }
        else { wrap.classList.remove('visible'); ret.required = false; }
    })();

    // Note: Swap button removed to match Home form style exactly on big screens
    
    const modifyBtn = document.getElementById('modifySearchBtn');
    const modifyPanel = document.getElementById('modifySearchPanel');
    modifyBtn?.addEventListener('click', () => { const hidden = modifyPanel.hasAttribute('hidden'); hidden ? modifyPanel.removeAttribute('hidden') : modifyPanel.setAttribute('hidden',''); modifyBtn.classList.toggle('open'); });
    const timerEl = document.getElementById('searchTimer'); let remaining = 15*60; setInterval(()=>{ if(remaining<0) return; remaining--; const m=String(Math.floor(remaining/60)).padStart(2,'0'); const s=String(remaining%60).padStart(2,'0'); timerEl.textContent=`${m}:${s}`; },1000);
    const cards=[...document.querySelectorAll('.flight-card')]; const prices=cards.map(c=>Number(c.dataset.price)); const priceSlider=document.getElementById('priceSlider'); const priceMinEl=document.getElementById('priceMin'); const priceMaxEl=document.getElementById('priceMax'); if(prices.length){ const minP=Math.min(...prices); const maxP=Math.max(...prices); priceSlider.min=minP; priceSlider.max=maxP; priceSlider.value=maxP; priceMinEl.textContent=`$${minP.toFixed(0)}`; priceMaxEl.textContent=`$${maxP.toFixed(0)}`; }

    // Stops dropdown control (dynamic: All, Direct, 1, 2, 3, ... based on data)
    let selectedStops = 'all'; // 'all' or number 0/1/2/...
    const stopsBtn = document.getElementById('stopsDropdownBtn');
    const stopsMenu = document.getElementById('stopsDropdownMenu');

    function parseStops(text){
        const t = (text||'').toString().toLowerCase();
        if(t.includes('non') && t.includes('stop')) return 0; // Non-stop
        const m = t.match(/(\d+)/);
        return m ? parseInt(m[1], 10) : null;
    }
    function formatStopsLabel(val){
        if(val==='all') return 'All';
        if(val===0) return 'Direct';
        if(typeof val === 'number') return `${val} Stop${val>1?'s':''}`;
        return 'All';
    }
    function setStopsFromDropdown(val){
        selectedStops = val; // 'all' or number
        if(stopsBtn){ stopsBtn.textContent = `Stops: ${formatStopsLabel(val)} ‚ñæ`; }
        applyFilters();
    }
    function toggleStopsMenu(show){ if(!stopsMenu) return; if(show===undefined){ show = stopsMenu.hasAttribute('hidden'); } if(show){ stopsMenu.removeAttribute('hidden'); stopsBtn?.setAttribute('aria-expanded','true'); } else { stopsMenu.setAttribute('hidden',''); stopsBtn?.setAttribute('aria-expanded','false'); } }
    stopsBtn?.addEventListener('click', ()=> toggleStopsMenu());
    document.addEventListener('click', (e)=>{ if(stopsMenu && !stopsMenu.contains(e.target) && !stopsBtn.contains(e.target)){ toggleStopsMenu(false); } });

    function buildStopsMenu(){
        if(!stopsMenu) return;
        stopsMenu.innerHTML = '';
        const counts = Array.from(new Set(cards.map(c => parseStops(c.dataset.stops)).filter(n => n !== null))).sort((a,b)=>a-b);
        // Always include All and Direct at top
        const options = ['all', 0, ...counts.filter(n=> n>=1)];
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'stops-option';
            btn.dataset.stops = String(opt);
            btn.style.cssText = 'display:block; width:100%; text-align:left; padding:10px 12px; background:none; border:0; cursor:pointer;';
            btn.textContent = formatStopsLabel(opt);
            btn.addEventListener('click', ()=>{ setStopsFromDropdown(opt === 'all' ? 'all' : Number(opt)); toggleStopsMenu(false); });
            stopsMenu.appendChild(btn);
        });
    }
    buildStopsMenu();

    function stopsMatches(selected, text){
        if(selected==='all') return true;
        const num = parseStops(text);
        if(num === null) return true;
        return num === selected;
    }
    function currentSelectedStops(){ return selectedStops; }
    function applyFilters(){ const sel = currentSelectedStops(); const maxPrice=Number(priceSlider.value); cards.forEach(card=>{ const okStops= stopsMatches(sel, card.dataset.stops); const okPrice= Number(card.dataset.price)<=maxPrice; card.style.display= okStops && okPrice ? '' : 'none'; }); }
    priceSlider.addEventListener('input',applyFilters);
    document.querySelectorAll('.sort-btn').forEach(btn=>btn.addEventListener('click',()=>{ document.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const order=btn.dataset.sort; const sorted=[...cards].sort((a,b)=> order==='asc'? a.dataset.price-b.dataset.price : b.dataset.price-a.dataset.price); const list=document.getElementById('flightsList'); sorted.forEach(c=>list.appendChild(c)); }));
    document.addEventListener('click',e=>{ if(e.target.classList.contains('flight-close-btn')){ document.getElementById('flightModal').setAttribute('hidden',''); } });
    // Details toggle
    document.querySelectorAll('.details-toggle-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            const panel = document.getElementById(btn.getAttribute('aria-controls'));
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            if(expanded){ panel.setAttribute('hidden',''); btn.setAttribute('aria-expanded','false'); }
            else { panel.removeAttribute('hidden'); btn.setAttribute('aria-expanded','true'); }
        });
    });
    
    // Populate airport city names in segment details
    document.querySelectorAll('.seg-city').forEach(el=>{
        const code = el.dataset.code;
        const airport = window.AIRPORTS[code];
        if(airport){
            const countryCode = airport.country;
            const countryName = window.COUNTRY_NAMES[countryCode] || countryCode;
            el.textContent = ` (${airport.city}${countryName ? ', ' + countryName : ''})`;
        }
    });
    
    // Format dates and times in segment details
    document.querySelectorAll('.seg-dep, .seg-arr').forEach(el=>{
        const timeEl = el.childNodes[el.childNodes.length - 1];
        if(timeEl && timeEl.nodeType === Node.TEXT_NODE){
            const dateStr = timeEl.textContent.trim();
            if(dateStr && dateStr.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/)){
                const date = new Date(dateStr);
                const formatted = date.toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                timeEl.textContent = ' ' + formatted;
            }
        }
    });
    
    // Cabin Selection Modal Logic
    const cabinModal = document.getElementById('cabinModal');
    const cabinCloseBtn = document.querySelector('.cabin-close-btn');
    const cabinOverlay = document.querySelector('.cabin-modal-overlay');
    const cabinOptions = document.getElementById('cabinOptions');
    
    console.log('Search page - Cabin modal elements:', {
        cabinModal,
        cabinCloseBtn,
        cabinOverlay,
        cabinOptions
    });
    
    // For roundtrip flights
    const cabinOutboundForm = document.getElementById('cabinOutboundForm');
    const selectedOutboundJson = document.getElementById('selectedOutboundJson');
    const selectedCabinOut = document.getElementById('selectedCabinOut');
    const formOrigin = document.getElementById('formOrigin');
    const formDestination = document.getElementById('formDestination');
    const formReturnDate = document.getElementById('formReturnDate');
    
    // For one-way flights
    const cabinOnewayForm = document.getElementById('cabinOnewayForm');
    const selectedOnewayJson = document.getElementById('selectedOnewayJson');
    const selectedCabinOneway = document.getElementById('selectedCabinOneway');
    
    let isRoundtrip = false;
    
    function showCabinModal(flightData, isRound, origin, destination, returnDate) {
        console.log('showCabinModal called', { flightData, isRound, origin, destination, returnDate });
        
        isRoundtrip = isRound;
        const faresByCabin = flightData.fares_by_cabin || {};
        
        console.log('Fares by cabin:', faresByCabin);
        
        // Store flight data
        if (isRoundtrip) {
            selectedOutboundJson.value = JSON.stringify(flightData);
            formOrigin.value = origin;
            formDestination.value = destination;
            formReturnDate.value = returnDate;
        } else {
            selectedOnewayJson.value = JSON.stringify(flightData);
        }
        
        // Build cabin options
        cabinOptions.innerHTML = '';
        const cabinNames = {
            'ECONOMY': 'Economy',
            'PREMIUM_ECONOMY': 'Premium Economy',
            'BUSINESS': 'Business',
            'FIRST': 'First Class'
        };
        
        const availableCabins = Object.keys(faresByCabin).sort((a, b) => {
            const order = ['ECONOMY', 'PREMIUM_ECONOMY', 'BUSINESS', 'FIRST'];
            return order.indexOf(a) - order.indexOf(b);
        });
        
        console.log('Available cabins:', availableCabins);
        
        if (availableCabins.length === 0) {
            cabinOptions.innerHTML = '<p class="no-cabins">No cabin options available for this flight.</p>';
        } else {
            availableCabins.forEach(cabin => {
                const fares = faresByCabin[cabin];
                if (fares && fares.length > 0) {
                    const fare = fares[0];
                    const price = fare.price;
                    
                    // Cabin details based on class
                    const cabinDetails = {
                        'ECONOMY': {
                            name: 'Economy',
                            subtitle: 'Standard / Basic',
                            description: 'Lowest price, minimal amenities',
                            icon: 'üí∫',
                            features: ['Standard seat', 'Carry-on included', 'Snacks & beverages', 'Standard boarding'],
                            seatPitch: '31-32"',
                            baggage: fare.includedCheckedBags?.quantity || 0,
                            refundable: false
                        },
                        'PREMIUM_ECONOMY': {
                            name: 'Premium Economy',
                            subtitle: 'Enhanced Comfort',
                            description: 'Extra legroom, priority boarding, better meals',
                            icon: 'ü™ë',
                            features: ['Extra legroom', 'Priority boarding', 'Enhanced meals', 'More recline', 'Premium beverages'],
                            seatPitch: '38-40"',
                            baggage: fare.includedCheckedBags?.quantity || 1,
                            refundable: false
                        },
                        'BUSINESS': {
                            name: 'Business Class',
                            subtitle: 'Executive',
                            description: 'Lie-flat seats, lounge access, premium meals',
                            icon: '‚úàÔ∏è',
                            features: ['Lie-flat seats', 'Lounge access', 'Premium dining', 'Priority check-in', 'Extra baggage'],
                            seatPitch: '60-78"',
                            baggage: fare.includedCheckedBags?.quantity || 2,
                            refundable: true
                        },
                        'FIRST': {
                            name: 'First Class',
                            subtitle: 'Suites / Luxury',
                            description: 'Top-tier luxury, private suites, fine dining',
                            icon: 'üëë',
                            features: ['Private suites', 'Fine dining', 'Premium service', 'Chauffeur service', 'Priority everything'],
                            seatPitch: '80+"',
                            baggage: fare.includedCheckedBags?.quantity || 3,
                            refundable: true
                        }
                    };
                    
                    const details = cabinDetails[cabin] || cabinDetails['ECONOMY'];
                    
                    const cabinCard = document.createElement('div');
                    cabinCard.className = 'cabin-option';
                    cabinCard.innerHTML = `
                        <div class="cabin-icon">${details.icon}</div>
                        <div class="cabin-info">
                            <div class="cabin-header">
                                <div class="cabin-title-group">
                                    <h3>${details.name}</h3>
                                    <span class="cabin-subtitle">${details.subtitle}</span>
                                </div>
                                <div class="cabin-price-group">
                                    <div class="cabin-price">$${parseFloat(price).toFixed(2)}</div>
                                    <span class="cabin-price-label">per person</span>
                                </div>
                            </div>
                            <p class="cabin-description">${details.description}</p>
                            <div class="cabin-features">
                                ${details.features.map(f => `<span class="feature-tag">‚úì ${f}</span>`).join('')}
                                <span class="feature-tag">Baggage: ${details.baggage} checked bag${details.baggage !== 1 ? 's' : ''} included</span>
                                <span class="feature-tag">${details.refundable ? 'Refundable' : 'Non-refundable'}</span>
                            </div>
                        </div>
                        <button type="button" class="cabin-select-btn" data-cabin="${cabin}">
                            Select ${details.name}
                        </button>
                    `;
                    cabinOptions.appendChild(cabinCard);
                }
            });
            
            // Add click handlers to cabin select buttons
            document.querySelectorAll('.cabin-select-btn').forEach(selectBtn => {
                selectBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Cabin selected:', selectBtn.dataset.cabin);
                    
                    if (isRoundtrip) {
                        selectedCabinOut.value = selectBtn.dataset.cabin;
                        cabinOutboundForm.submit();
                    } else {
                        selectedCabinOneway.value = selectBtn.dataset.cabin;
                        cabinOnewayForm.submit();
                    }
                });
            });
        }
        
        // Show modal
        console.log('Showing cabin modal');
        cabinModal.removeAttribute('hidden');
        cabinModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    // Handle roundtrip flight selection
    document.querySelectorAll('.select-outbound-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Outbound select button clicked');
            
            const flightData = JSON.parse(btn.dataset.flight);
            const origin = btn.dataset.origin;
            const destination = btn.dataset.destination;
            const returnDate = btn.dataset.returnDate;
            showCabinModal(flightData, true, origin, destination, returnDate);
        });
    });
    
    // Handle one-way flight selection
    document.querySelectorAll('.select-oneway-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Oneway select button clicked');
            
            const flightData = JSON.parse(btn.dataset.flight);
            showCabinModal(flightData, false);
        });
    });
    
    // Close modal handlers
    function closeCabinModal() {
        console.log('Closing cabin modal');
        cabinModal.setAttribute('hidden', '');
        cabinModal.style.display = 'none';
        document.body.style.overflow = '';
    }
    
    if (cabinCloseBtn) {
        cabinCloseBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Close button clicked');
            closeCabinModal();
        });
    }
    
    if (cabinOverlay) {
        cabinOverlay.addEventListener('click', (e) => {
            console.log('Overlay clicked');
            closeCabinModal();
        });
    }
    
    // Close on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !cabinModal.hasAttribute('hidden')) {
            console.log('Escape key pressed');
            closeCabinModal();
        }
    });
</script>
{% endblock %}
