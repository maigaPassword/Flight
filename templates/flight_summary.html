{% extends "base.html" %}
{% block title %}Trip Summary{% endblock %}

{% block head %}
<style>
.results-page {
  background: linear-gradient(135deg, #caf0f8 0%, #ade8f4 100%);
  min-height: 100vh;
  padding: 4rem 0;
}

.results-page > h2 {
  text-align: center;
  font-size: 3.5rem;
  background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 3.5rem;
  font-weight: 800;
  letter-spacing: -1.5px;
}

.summary-layout {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 2rem;
  display: grid;
  grid-template-columns: 1fr 440px;
  gap: 3rem;
  align-items: start;
}

.summary-main {
  display: flex;
  flex-direction: column;
  gap: 2.5rem;
}

.summary-card {
  background: white;
  border-radius: 24px;
  padding: 3rem;
  box-shadow: 0 10px 40px rgba(0, 180, 216, 0.12);
  border: 1px solid rgba(72, 202, 228, 0.2);
}

.flight-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 2.5rem;
  padding-bottom: 2rem;
  border-bottom: 3px solid #f0f9ff;
}

.flight-header h3 {
  font-size: 1.75rem;
  color: #0077b6;
  font-weight: 700;
  margin: 0.75rem 0 0 0;
  letter-spacing: -0.5px;
}

.airline-logo {
  width: 60px;
  height: 60px;
  object-fit: contain;
  border-radius: 14px;
  padding: 0.75rem;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f7ff 100%);
  border: 2px solid rgba(72, 202, 228, 0.2);
}

.summary-chip {
  display: inline-block;
  background: linear-gradient(135deg, #48cae4, #90e0ef);
  color: white;
  padding: 0.5rem 1.25rem;
  border-radius: 25px;
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  box-shadow: 0 4px 12px rgba(72, 202, 228, 0.35);
}

.flight-header .price {
  font-size: 2.5rem;
  font-weight: 900;
  background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -1px;
}

.itinerary {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 3rem;
  align-items: center;
  margin-bottom: 2rem;
  padding: 2rem;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f7ff 100%);
  border-radius: 20px;
  border: 2px solid rgba(72, 202, 228, 0.15);
}

.itinerary .col {
  text-align: center;
}

.time-lg {
  font-size: 2.5rem;
  font-weight: 900;
  color: #0077b6;
  letter-spacing: -1px;
  margin-bottom: 0.5rem;
}

.day-sub {
  font-size: 1rem;
  color: #0096c7;
  margin: 0.75rem 0;
  font-weight: 600;
}

.city {
  font-size: 1.2rem;
  color: #0077b6;
  font-weight: 700;
  margin-top: 0.5rem;
}

.itinerary .meta {
  text-align: center;
  padding: 0 1.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.75rem;
}

.arrow {
  font-size: 2.5rem;
  color: #48cae4;
  font-weight: bold;
}

.dur {
  font-size: 1rem;
  color: #0096c7;
  font-weight: 700;
  background: white;
  padding: 0.5rem 1.25rem;
  border-radius: 20px;
  box-shadow: 0 2px 8px rgba(72, 202, 228, 0.15);
}

.stops {
  font-size: 0.9rem;
  color: #48cae4;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.pill {
  display: inline-block;
  background: linear-gradient(135deg, rgba(72, 202, 228, 0.15), rgba(144, 224, 239, 0.15));
  border: 2px solid rgba(72, 202, 228, 0.4);
  color: #0077b6;
  padding: 0.85rem 2rem;
  border-radius: 30px;
  font-weight: 700;
  font-size: 1rem;
  letter-spacing: 0.3px;
}

.summary-actions {
  margin-top: 2rem;
  display: flex;
  gap: 1.25rem;
  justify-content: flex-end;
  align-items: center;
}

.details-toggle {
  background: white;
  border: 2px solid #48cae4;
  color: #0077b6;
  padding: 0.85rem 2rem;
  border-radius: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 1rem;
}

.details-toggle:hover {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f7ff 100%);
  border-color: #0077b6;
  color: #0077b6;
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(72, 202, 228, 0.25);
}

.segment-list {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 3px solid #f0f9ff;
}

.details-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.details-list li {
  display: grid;
  grid-template-columns: auto auto 1fr auto;
  gap: 1.5rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #f0f9ff 0%, white 100%);
  border-radius: 16px;
  margin-bottom: 1rem;
  border: 2px solid rgba(72, 202, 228, 0.15);
}

.details-list .t {
  font-weight: 800;
  color: #0077b6;
  font-size: 1.1rem;
}

.details-list .d {
  color: #0096c7;
  font-size: 0.95rem;
  font-weight: 600;
}

.details-list .route {
  color: #0077b6;
  font-weight: 700;
  font-size: 1.05rem;
}

.summary-sidebar {
  position: sticky;
  top: 2rem;
}

.checkout-card {
  background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
  color: #0077b6;
  border: 3px solid rgba(72, 202, 228, 0.3);
  box-shadow: 0 12px 48px rgba(0, 180, 216, 0.2);
}

.checkout-header h3 {
  font-size: 2rem;
  margin: 0 0 2rem 0;
  color: #0077b6;
  font-weight: 800;
  letter-spacing: -0.75px;
  padding-bottom: 1.75rem;
  border-bottom: 3px solid rgba(72, 202, 228, 0.2);
}

.price-rows {
  display: flex;
  flex-direction: column;
  gap: 0.85rem;
}

.price-row {
  display: flex;
  justify-content: space-between;
  padding: 0.75rem 0;
  color: #0096c7;
  font-size: 1.05rem;
  font-weight: 600;
}

.price-row span:first-child {
  color: #0096c7;
}

.price-row span:last-child {
  font-weight: 800;
  color: #0077b6;
}

.price-total {
  margin-top: 1.25rem;
  padding-top: 1.75rem;
  border-top: 3px solid rgba(72, 202, 228, 0.3);
  font-size: 2rem;
  font-weight: 900;
  background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.checkout-actions {
  margin-top: 2.5rem;
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
}

.checkout-actions .select-btn {
  background: white;
  color: #0077b6;
  border: 2px solid #48cae4;
  padding: 1.15rem 2.5rem;
  border-radius: 14px;
  font-weight: 700;
  text-align: center;
  text-decoration: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 1.1rem;
}

.checkout-actions .select-btn:hover {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f7ff 100%);
  border-color: #0077b6;
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(72, 202, 228, 0.3);
}

.checkout-actions .btn-primary {
  background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
  color: white;
  border: 2px solid transparent;
  padding: 1.35rem 2.5rem;
  border-radius: 14px;
  font-weight: 800;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 1.15rem;
  width: 100%;
  letter-spacing: 0.3px;
  box-shadow: 0 8px 24px rgba(0, 119, 182, 0.35);
}

.checkout-actions .btn-primary:hover {
  background: linear-gradient(135deg, #00b4d8 0%, #48cae4 100%);
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(0, 180, 216, 0.45);
}

@media (max-width: 1024px) {
  .summary-layout {
    grid-template-columns: 1fr;
  }
  
  .summary-sidebar {
    position: static;
  }
}

@media (max-width: 768px) {
  .results-page > h2 {
    font-size: 2.5rem;
  }
  
  .summary-card {
    padding: 2rem;
  }
  
  .itinerary {
    grid-template-columns: 1fr;
    gap: 2rem;
  }
  
  .itinerary .meta {
    order: -1;
  }
  
  .time-lg {
    font-size: 2rem;
  }
  
  .flight-header .price {
    font-size: 2rem;
  }
  
  .details-list li {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
}
</style>
{% endblock %}

{% block content %}
<section class="results-page">
  <h2>Review your trip</h2>

  <div class="summary-layout">
    <div class="summary-main">
  <!-- Outbound Card -->
  <div class="flight-card summary-card" data-segments='{{ outbound.segments | tojson | safe }}'>
    <div class="flight-header">
      <div style="display:flex;align-items:center;gap:10px;">
        {% if outbound.airline_logo %}
          <img src="{{ outbound.airline_logo }}" alt="{{ outbound.airline_name }}" class="airline-logo">
        {% endif %}
        <div>
          <div class="summary-chip">Outbound</div>
          <h3>{{ outbound.airline_name }}</h3>
        </div>
      </div>
      <p class="price">${{ "%.2f"|format(price_out) }}</p>
    </div>
    <div class="itinerary">
      <div class="col">
        <div class="time-lg">{{ out_dep_time }}</div>
        <div class="day-sub">{{ outbound.departure | date_compact }}</div>
        <div class="city">{{ origin_city }} ({{ outbound.origin }})</div>
      </div>
      <div class="meta">
        <div class="arrow">→</div>
        <div class="dur"><strong>{{ outbound.duration }}</strong></div>
        {% if outbound.stops_text %}<div class="stops">{{ outbound.stops_text }}</div>{% endif %}
      </div>
      <div class="col">
        <div class="time-lg">{{ out_arr_time }}</div>
        <div class="day-sub">{{ outbound.arrival | date_compact }}</div>
        <div class="city">{{ destination_city }} ({{ outbound.destination }})</div>
      </div>
    </div>
    <div class="pill">Cabin: {{ cabin_out }}</div>
    <div class="summary-actions" style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
      <button class="select-btn details-toggle" data-target="#outbound-details">Details</button>
      
      <!-- Seat Selection Button -->
      <form action="/seat_selection" method="POST" style="margin: 0; display: inline;">
        <input type="hidden" name="outbound_json" value='{{ outbound | tojson | safe }}'>
        {% if return_flight %}
          <input type="hidden" name="return_json" value='{{ return_flight | tojson | safe }}'>
          <input type="hidden" name="cabin_ret" value="{{ cabin_ret }}">
        {% endif %}
        <input type="hidden" name="cabin_out" value="{{ cabin_out }}">
        <input type="hidden" name="total_price" value="{{ total_price }}">
        {% if base_total is not none %}
          <input type="hidden" name="base_total" value="{{ base_total }}">
        {% endif %}
        {% if taxes_total is not none %}
          <input type="hidden" name="taxes_total" value="{{ taxes_total }}">
        {% endif %}
        <input type="hidden" name="adults" value="{{ adults }}">
        <input type="hidden" name="children" value="{{ children }}">
        <input type="hidden" name="infants" value="{{ infants }}">
        
        <button type="submit" class="btn-seat-selection">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.4rem;">
            <rect x="3" y="6" width="18" height="12" rx="2"></rect>
            <path d="M3 10h18M3 14h18"></path>
          </svg>
          Select Seats
        </button>
      </form>
    </div>
    <div id="outbound-details" class="segment-list" style="display:none;">
      <ul class="details-list">
        {% for s in outbound.segments %}
          {% set oc = AIRPORTS.get(s.origin, {}).get('city', s.origin) %}
          {% set dc = AIRPORTS.get(s.destination, {}).get('city', s.destination) %}
          <li>
            <span class="t">{{ s.departure | time12 }}</span>
            <span class="d">{{ s.departure | date_compact }}</span>
            <span class="route">{{ oc }} ({{ s.origin }}) → {{ dc }} ({{ s.destination }})</span>
            <span class="t">{{ s.arrival | time12 }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  {% if return_flight %}
  <!-- Return Card -->
  <div class="flight-card summary-card" data-segments='{{ return_flight.segments | tojson | safe }}'>
    <div class="flight-header">
      <div style="display:flex;align-items:center;gap:10px;">
        {% if return_flight.airline_logo %}
          <img src="{{ return_flight.airline_logo }}" alt="{{ return_flight.airline_name }}" class="airline-logo">
        {% endif %}
        <div>
          <div class="summary-chip">Return</div>
          <h3>{{ return_flight.airline_name }}</h3>
        </div>
      </div>
      <p class="price">${{ "%.2f"|format(price_ret) }}</p>
    </div>
    <div class="itinerary">
      <div class="col">
        <div class="time-lg">{{ ret_dep_time }}</div>
        <div class="day-sub">{{ return_flight.departure | date_compact }}</div>
        <div class="city">{{ destination_city }} ({{ return_flight.origin }})</div>
      </div>
      <div class="meta">
        <div class="arrow">→</div>
        <div class="dur"><strong>{{ return_flight.duration }}</strong></div>
        {% if return_flight.stops_text %}<div class="stops">{{ return_flight.stops_text }}</div>{% endif %}
      </div>
      <div class="col">
        <div class="time-lg">{{ ret_arr_time }}</div>
        <div class="day-sub">{{ return_flight.arrival | date_compact }}</div>
        <div class="city">{{ origin_city }} ({{ return_flight.destination }})</div>
      </div>
    </div>
    <div class="pill">Cabin: {{ cabin_ret }}</div>
    <div class="summary-actions" style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
      <button class="select-btn details-toggle" data-target="#return-details">Details</button>
    </div>
    <div id="return-details" class="segment-list" style="display:none;">
      <ul class="details-list">
        {% for s in return_flight.segments %}
          {% set oc = AIRPORTS.get(s.origin, {}).get('city', s.origin) %}
          {% set dc = AIRPORTS.get(s.destination, {}).get('city', s.destination) %}
          <li>
            <span class="t">{{ s.departure | time12 }}</span>
            <span class="d">{{ s.departure | date_compact }}</span>
            <span class="route">{{ oc }} ({{ s.origin }}) → {{ dc }} ({{ s.destination }})</span>
            <span class="t">{{ s.arrival | time12 }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}
    </div>

    <aside class="summary-sidebar">
      <div class="flight-card summary-card checkout-card">
        <div class="checkout-header">
          <h3>Price Summary</h3>
        </div>
        
        <!-- Passenger Information -->
        <div class="price-rows" style="border-bottom: 1px solid #e0e0e0; padding-bottom: 1rem; margin-bottom: 1rem;">
          <div class="price-row" style="font-weight: 600; color: #1a1a1a; margin-bottom: 0.5rem;">
            <span>Passengers</span>
            <span>{{ total_passengers }}</span>
          </div>
          {% if adults > 0 %}
          <div class="price-row" style="font-size: 0.9rem; color: #666;">
            <span>{{ adults }} Adult{{ 's' if adults > 1 else '' }}</span>
          </div>
          {% endif %}
          {% if children > 0 %}
          <div class="price-row" style="font-size: 0.9rem; color: #666;">
            <span>{{ children }} Child{{ 'ren' if children > 1 else '' }}</span>
          </div>
          {% endif %}
          {% if infants > 0 %}
          <div class="price-row" style="font-size: 0.9rem; color: #666;">
            <span>{{ infants }} Infant{{ 's' if infants > 1 else '' }}</span>
          </div>
          {% endif %}
        </div>
        
        <div class="price-rows">
          {% if base_total is not none %}
            <div class="price-row"><span>Fare subtotal</span><span>${{ "%.2f"|format(base_total) }}</span></div>
          {% endif %}
          {% if taxes_total is not none %}
            <div class="price-row"><span>Taxes & fees</span><span>${{ "%.2f"|format(taxes_total) }}</span></div>
          {% else %}
            <div class="price-row"><span>Taxes & fees</span><span>Included</span></div>
          {% endif %}
          <div class="price-row price-total"><span>Total</span><span>${{ "%.2f"|format(total_price) }}</span></div>
        </div>
        <div class="checkout-actions">
          <a class="select-btn" href="/search">Change flights</a>
          <form action="/booking" method="POST" style="margin: 0;">
            <input type="hidden" name="outbound_json" value='{{ outbound | tojson | safe }}'>
            {% if return_flight %}
              <input type="hidden" name="return_json" value='{{ return_flight | tojson | safe }}'>
              <input type="hidden" name="cabin_ret" value="{{ cabin_ret }}">
            {% endif %}
            <input type="hidden" name="cabin_out" value="{{ cabin_out }}">
            <input type="hidden" name="total_price" value="{{ total_price }}">
            {% if base_total is not none %}
              <input type="hidden" name="base_total" value="{{ base_total }}">
            {% endif %}
            {% if taxes_total is not none %}
              <input type="hidden" name="taxes_total" value="{{ taxes_total }}">
            {% endif %}
            
            <!-- Continue without seat selection -->
            <button type="submit" class="btn btn-primary">Continue to Booking</button>
          </form>
        </div>
      </div>
    </aside>
  </div>
</section>

<style>
.btn-seat-selection {
    background: linear-gradient(135deg, #48cae4, #90e0ef) !important;
    border: 2px solid transparent !important;
    color: white !important;
    padding: 0.85rem 2rem !important;
    border-radius: 14px !important;
    font-weight: 700 !important;
    font-size: 1rem !important;
    cursor: pointer !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    white-space: nowrap !important;
    box-shadow: 0 4px 16px rgba(72, 202, 228, 0.3) !important;
}

.btn-seat-selection:hover {
    background: linear-gradient(135deg, #0077b6, #00b4d8) !important;
    transform: translateY(-3px) !important;
    box-shadow: 0 8px 24px rgba(0, 119, 182, 0.4) !important;
}

.btn-seat-selection svg {
    stroke: white !important;
    flex-shrink: 0 !important;
}

/* Ensure summary-actions buttons align properly */
.summary-actions {
    align-items: center !important;
}

.summary-actions form {
    display: inline !important;
}
</style>

<script>
  // Toggle segment details panels
  document.querySelectorAll('.details-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = document.querySelector(btn.dataset.target);
      if (!target) return;
      const visible = target.style.display !== 'none';
      target.style.display = visible ? 'none' : 'block';
      btn.textContent = visible ? 'Details' : 'Hide details';
    });
  });
</script>
{% endblock %}
